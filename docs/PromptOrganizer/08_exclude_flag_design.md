# プロンプト整理対象外フラグ機能 設計書

## 概要

一度整理に使用したプロンプトを整理対象外にすることで、同じプロンプトが精製（自動整理）されるのを抑止する機能。
ユーザーの任意で整理対象に戻すこともできる。

---

## 機能要件

### 1. プロンプトへの対象外フラグの追加

- プロンプトの設定値として、「プロンプト整理の対象外」フラグを設定・解除可能にする
- フラグのデフォルト値は `false` とする
- 既存のプロンプトとの互換性を保つため、フィールドはOptionalとする

### 2. プロンプト整理時のフィルタリング

- プロンプト整理実行時、「プロンプト整理の対象外」が `true` のプロンプトはフィルターで除外する
- フィルタリングの優先順位：
  1. プロンプト整理の対象外（`excludeFromOrganizer: true`）を除外
  2. 実行時期による絞り込み
  3. 実行回数による絞り込み

  ※ AI自動作成プロンプトの除外（`isAIGenerated: true`）は行わず、本フラグに統合する

### 3. フラグの更新方法

#### 手動更新

- プロンプトの編集ダイアログ上で、チェックボックスによりフラグを手動で更新できる
- 編集ダイアログの「詳細設定」セクションに配置する
- AI自動作成プロンプトの編集時も同様に設定可能

#### 自動更新

- プロンプトの自動整理が実行された際、以下のプロンプトの「プロンプト整理の対象外」を自動的に `true` に設定する：
  1. **整理対象にしたプロンプト**: 整理のために Gemini API に送信されたプロンプト
  2. **精製（生成）されたプロンプト**: 整理結果として生成され、ユーザーが保存したAI自動作成プロンプト
- 自動更新のタイミング：
  - 整理対象プロンプト: 整理実行直後（Gemini API呼び出し成功後）
  - 生成プロンプト: ユーザーがプレビュー画面で「保存」または「保存してお気に入り」を選択した時点

### 4. フラグの解除方法

- 編集ダイアログでチェックボックスをオフにすることで、フラグを `false` に戻せる
- フラグが `false` のプロンプトは、次回の整理実行時に再度対象となる可能性がある

---

## データモデル

### Prompt 型の拡張

**実装ファイル**: `src/types/prompt.ts`

既存の Prompt 型に以下のフィールドを追加：

**新規追加フィールド**:

- `excludeFromOrganizer`: プロンプト整理の対象外フラグ（Optional, デフォルト: `false`）

**フィールド仕様**:

| フィールド名           | 型        | 必須   | デフォルト | 説明                                                                                  |
| ---------------------- | --------- | ------ | ---------- | ------------------------------------------------------------------------------------- |
| `excludeFromOrganizer` | `boolean` | いいえ | `false`    | プロンプト整理の対象外とするフラグ。`true` の場合、自動整理時にフィルターで除外される |

**データ整合性**:

- 既存プロンプト（フィールドが未定義）は `false` として扱われる
- StoredPrompt 型にも同様のフィールドを追加（Optional）
- SaveDialogData 型にも同様のフィールドを追加（編集ダイアログで使用）

---

## アーキテクチャ

### 1. 型定義の拡張

**影響を受けるファイル**:

- `src/types/prompt.ts`
  - `Prompt` インターフェース
  - `StoredPrompt` インターフェース
  - `SaveDialogData` インターフェース

### 2. フィルター処理の拡張

**影響を受けるファイル**:

- `src/services/promptOrganizer/PromptFilterService.ts`
  - `filterPrompts()` メソッド内のフィルタリングロジックに条件を追加

**フィルタリングロジックの優先順位**:

1. **NEW**: 整理対象外フラグの除外（`excludeFromOrganizer === true`）
2. 実行時期による絞り込み（`lastExecutedAt` が期間内）
3. 実行回数による絞り込み（`executionCount >= 最低実行回数`）
4. 実行回数降順でソート
5. 最大件数で切り詰め

※AI自動作成プロンプトの除外（`isAIGenerated === true`）は、本フラグに統合し、除外しないように変更

### 3. 編集ダイアログの拡張

**影響を受けるファイル**:

- `src/components/inputMenu/controller/EditDialog.tsx`
  - 「詳細設定」セクションに「プロンプト整理の対象外」チェックボックスを追加
  - フォーム状態に `excludeFromOrganizer` を追加
  - 保存時に `SaveDialogData` に含める

**UI配置**:

- 既存の「AI自動作成プロンプト」セクションの下に配置
- チェックボックス形式で表示
- ラベル: 「プロンプト整理の対象外」（i18n対応）

### 4. 自動整理実行時のフラグ更新

**影響を受けるファイル**:

- `src/services/promptOrganizer/PromptOrganizerService.ts`
  - 整理実行後、対象プロンプトのフラグを一括更新
- `src/hooks/usePromptOrganizer.ts`
  - プレビュー画面で保存時、生成プロンプトのフラグを設定

**更新タイミング**:

1. **整理対象プロンプトのフラグ更新**:
   - `PromptOrganizerService.organizePrompts()` 実行後
   - Gemini API呼び出しが成功した時点
   - 対象プロンプトの `excludeFromOrganizer` を `true` に更新

2. **生成プロンプトのフラグ設定**:
   - `usePromptOrganizer.saveTemplate()` 実行時
   - TemplateCandidate から Prompt に変換する際に設定
   - `excludeFromOrganizer: true` として保存

---

## UI/UX フロー

### 1. プロンプト編集画面

```
+------------------------------------------+
| プロンプト編集                           |
+------------------------------------------+
| 名前: [__________________________]       |
|                                          |
| プロンプト:                              |
| [________________________________]       |
| [    プロンプト内容              ]       |
| [________________________________]       |
|                                          |
| --- 変数設定 ---                         |
| (変数設定UI)                             |
|                                          |
| --- 詳細設定 ---                         |
| □ プロンプト整理の対象外                 |
|   (チェックすると、自動整理の対象から    |
|    除外されます)                         |
|                                          |
| [キャンセル]              [保存]         |
+------------------------------------------+
```

### 2. プロンプト整理実行フロー

```
[ユーザーが「整理する」ボタンを押す]
  ↓
[対象プロンプトをフィルタリング]
  ↓
  1. excludeFromOrganizer === true → 除外
  2. lastExecutedAt が期間外 → 除外
  3. executionCount < 最低回数 → 除外
  ↓
[フィルタリング後のプロンプトを Gemini に送信]
  ↓
[整理実行成功]
  ↓
[対象にしたプロンプトの excludeFromOrganizer を true に更新]
  ↓
[プレビュー画面を表示]
  ↓
[ユーザーがテンプレートを保存]
  ↓
[生成プロンプトを excludeFromOrganizer: true で保存]
```

### 3. フラグ解除フロー

```
[ユーザーがプロンプトを編集]
  ↓
[編集ダイアログを開く]
  ↓
[「プロンプト整理の対象外」チェックボックスを確認]
  ↓
  チェックON → 現在、整理対象外
  チェックOFF → 現在、整理対象
  ↓
[チェックを外す]
  ↓
[保存ボタンを押す]
  ↓
[excludeFromOrganizer を false に更新]
  ↓
[次回の整理実行時、再び対象となる]
```

---

## 外部仕様

### 1. フィルタリング条件の変更

**変更前のフィルタリング条件**:

- AI自動作成プロンプトを除外（`isAIGenerated === true`）
- 実行時期が期間内
- 実行回数が最低回数以上

**変更後のフィルタリング条件**:

- **NEW**: プロンプト整理の対象外を除外（`excludeFromOrganizer === true`）
- 実行時期が期間内
- 実行回数が最低回数以上

### 2. 編集ダイアログの UI 変更

**追加UI要素**:

- チェックボックス: 「プロンプト整理の対象外」
- 配置: 詳細設定セクション
- ヘルプテキスト: 「チェックすると、自動整理の対象から除外されます」

### 3. 自動整理実行時の動作変更

**整理実行後の処理**:

1. Gemini API呼び出し成功後、対象にしたプロンプトの `excludeFromOrganizer` を `true` に更新
2. プレビュー画面で保存されたテンプレートは、`excludeFromOrganizer: true` で保存

**影響を受けるプロンプト**:

- 整理対象として選択されたプロンプト（自動的に対象外に設定）
- 生成されたAI自動作成プロンプト（保存時に対象外に設定）

### 4. インポート/エクスポート対応

**エクスポート時**:

- `excludeFromOrganizer` フィールドをCSVに含める
- フィールド名: `excludeFromOrganizer`
- 値: `true` または `false`（空の場合は `false` として扱う）

**インポート時**:

- `excludeFromOrganizer` フィールドが存在する場合、値を読み込む
- フィールドが存在しない場合、`false` として扱う（後方互換性）

---

## i18n 対応

### 翻訳キーの追加

**英語（en.yml）**:

```yaml
prompt:
  edit:
    excludeFromOrganizer: "Exclude from prompt organization"
    excludeFromOrganizerHelp: "When checked, this prompt will be excluded from automatic organization"
```

**日本語（ja.yml）**:

```yaml
prompt:
  edit:
    excludeFromOrganizer: "プロンプト整理の対象外"
    excludeFromOrganizerHelp: "チェックすると、自動整理の対象から除外されます"
```

---

## テスト設計

### ユニットテスト

#### 1. PromptFilterService.test.ts

**新規テストケース**:

- **フィルタリング - 対象外フラグが true のプロンプトを除外**
  - 入力: `excludeFromOrganizer: true` のプロンプトを含むリスト
  - 期待結果: 該当プロンプトが除外される

- **フィルタリング - 対象外フラグが false のプロンプトは含まれる**
  - 入力: `excludeFromOrganizer: false` のプロンプトを含むリスト
  - 期待結果: 該当プロンプトが含まれる

- **フィルタリング - 対象外フラグが未定義のプロンプトは含まれる**
  - 入力: `excludeFromOrganizer` フィールドが未定義のプロンプト
  - 期待結果: 該当プロンプトが含まれる（デフォルト: `false`）

- **フィルタリングの優先順位**
  - 入力: AI自動作成 + 対象外フラグ + 期間外 + 実行回数不足のプロンプト混在
  - 期待結果: 正しい優先順位で除外される

#### 2. EditDialog.test.tsx

**新規テストケース**:

- **レンダリング - 対象外フラグのチェックボックスが表示される**
  - 期待結果: チェックボックスが詳細設定セクションに表示される

- **初期状態 - フラグが true の場合、チェックボックスがON**
  - 入力: `excludeFromOrganizer: true` のプロンプト
  - 期待結果: チェックボックスがチェック状態

- **初期状態 - フラグが false の場合、チェックボックスがOFF**
  - 入力: `excludeFromOrganizer: false` のプロンプト
  - 期待結果: チェックボックスが未チェック状態

- **初期状態 - フラグが未定義の場合、チェックボックスがOFF**
  - 入力: `excludeFromOrganizer` が未定義のプロンプト
  - 期待結果: チェックボックスが未チェック状態

- **ユーザー操作 - チェックボックスをONにして保存**
  - 操作: チェックボックスをON → 保存ボタンを押す
  - 期待結果: `SaveDialogData.excludeFromOrganizer` が `true`

- **ユーザー操作 - チェックボックスをOFFにして保存**
  - 操作: チェックボックスをOFF → 保存ボタンを押す
  - 期待結果: `SaveDialogData.excludeFromOrganizer` が `false`

#### 3. PromptOrganizerService.test.ts

**新規テストケース**:

- **整理実行後 - 対象プロンプトのフラグが更新される**
  - 前提: 整理実行前、対象プロンプトの `excludeFromOrganizer` が `false`
  - 期待結果: 整理実行後、対象プロンプトの `excludeFromOrganizer` が `true`

- **整理実行後 - 対象外プロンプトのフラグは変更されない**
  - 前提: 整理対象外のプロンプトが存在
  - 期待結果: 対象外プロンプトの `excludeFromOrganizer` は変更されない

#### 4. usePromptOrganizer.test.ts

**新規テストケース**:

- **テンプレート保存時 - 生成プロンプトのフラグが true に設定される**
  - 操作: `saveTemplate()` を呼び出す
  - 期待結果: 保存されたプロンプトの `excludeFromOrganizer` が `true`

#### 5. promptImportService.test.ts / promptExportService.test.ts

**新規テストケース**:

- **エクスポート - excludeFromOrganizer フィールドを含む**
  - 入力: `excludeFromOrganizer: true` のプロンプト
  - 期待結果: CSVに `excludeFromOrganizer` フィールドが含まれ、値が `true`

- **インポート - excludeFromOrganizer フィールドを正しく読み込む**
  - 入力: `excludeFromOrganizer: true` を含むCSV
  - 期待結果: プロンプトの `excludeFromOrganizer` が `true`

- **インポート - excludeFromOrganizer フィールドがない場合、デフォルト値**
  - 入力: `excludeFromOrganizer` フィールドがないCSV
  - 期待結果: プロンプトの `excludeFromOrganizer` が `false`（または `undefined`）

### E2Eテスト

**テストシナリオ**:

1. **プロンプトを作成 → 整理実行 → 対象外フラグが自動設定される**
   - プロンプトを複数作成
   - 自動整理を実行
   - 対象にしたプロンプトの編集画面を開く
   - 「プロンプト整理の対象外」チェックボックスがONになっていることを確認

2. **対象外フラグをOFFにして再度整理 → 再び対象になる**
   - 対象外フラグがONのプロンプトの編集画面を開く
   - チェックボックスをOFFにして保存
   - 再度自動整理を実行
   - そのプロンプトが整理対象に含まれることを確認

3. **生成プロンプトの対象外フラグが設定される**
   - 自動整理を実行してプレビュー画面を表示
   - テンプレートを保存
   - 保存されたAI自動作成プロンプトの編集画面を開く
   - 「プロンプト整理の対象外」チェックボックスがONになっていることを確認

---

## データ移行

### 既存データとの互換性

- `excludeFromOrganizer` フィールドは Optional であり、既存プロンプトには影響しない
- 既存プロンプト（フィールド未定義）は `false` として扱われる
- StoredPrompt 型も同様に Optional フィールドとして拡張

### マイグレーション不要

- 新規フィールドは Optional であり、既存データ構造を変更しないため、マイグレーションは不要
- フィールドが未定義の場合、デフォルト値（`false`）として扱うロジックで対応

---

## セキュリティ考慮

- フラグの値は `true` または `false` のみ
- ユーザー入力による不正な値の設定を防ぐため、型チェックを実施
- フラグの自動更新は、整理実行成功後のみ行う

---

## パフォーマンス考慮

- フィルタリング処理への影響は最小限（単純な真偽値チェックを1つ追加）
- 既存プロンプトの `excludeFromOrganizer` フィールドは `undefined` のため、データサイズの増加なし
- フラグが `true` のプロンプトのみ、ストレージに保存される際にフィールドが追加される

---

## 実装優先順位

### Phase 1: 基本機能

1. 型定義の拡張（`Prompt`, `StoredPrompt`, `SaveDialogData`）
2. フィルター処理の拡張（`PromptFilterService`）
3. 編集ダイアログの UI 追加（`EditDialog`）

### Phase 2: 自動更新機能

4. 整理実行時のフラグ自動更新（`PromptOrganizerService`）
5. テンプレート保存時のフラグ設定（`usePromptOrganizer`）

### Phase 3: インポート/エクスポート対応

6. エクスポート機能の拡張（`promptExportService`）
7. インポート機能の拡張（`promptImportService`）

### Phase 4: テスト

8. ユニットテストの追加
9. E2Eテストの追加

---

## 注意事項

- フラグの自動更新は、整理実行成功後のみ行う（Gemini API エラー時は更新しない）
- 生成プロンプトのフラグは、ユーザーが保存を選択した時点で設定する（プレビューのみでは設定しない）
- フラグが `true` のプロンプトでも、ユーザーが手動で編集してフラグを `false` に戻せば、再度整理対象となる
