### 機能概要

- Gemini API を用いて、ユーザーの過去プロンプトから再利用性の高いテンプレートと変数部分を自動抽出し、`AI自動作成`プロンプトとして保存・提案する機能を提供する。
- ユーザーが安心して利用できるよう、「何がどのように整理され、どれくらいのコストがかかりそうか」を可視化し、整理結果を分かりやすくプレビュー・説明する。
- Pinned リストの体験を損なわない形で `AI自動作成`プロンプトを提示し、ユースケース／カテゴリによる選択性を高める。

---

### 機能要件

#### 1. Gemini による自動整理

- 過去プロンプトの解析
  - ユーザーのプロンプト履歴から、再利用可能なプロンプト候補を抽出する。
  - 類似プロンプト群をクラスタリングし、共通部分と可変部分（顧客名・日付・数値など）を抽出し、可変部分を変数としてテンプレート化する。
- 保存仕様
  - 生成されたテンプレートは `AI自動作成`フラグを付与して PromptService に保存する。
  - 各テンプレートには以下のメタ情報を付与する：
    - 元になったプロンプト件数・期間（例：過去30日・7件）
    - 抽出された変数の一覧
    - 自動推定された「ユースケース」と「カテゴリ」（詳細は後述）

---

#### 2. 「AI自動作成」の安心感を強化する

- 情報開示用メタデータ
  - `AI自動作成`プロンプトの詳細ビューにて、以下を確認可能にする：
    - 生成日時
    - 参照した履歴の件数・期間（例：対象：過去90日／20件）
    - 「ユースケース」「カテゴリ」候補
    - 抽出された変数一覧（例：`{client_name}`, `{project_name}`, `{due_date}`）
- ステータス表示
  - 初回未確認の `AI自動作成`プロンプトには「未確認」のステータスバッジを表示する。
  - ユーザーがプレビュー画面で内容を確認し、「保存」または「編集して保存」を行ったタイミングで「通常」ステータスに遷移する。
- 利用範囲の明示
  - 自動整理設定ダイアログ内に、「どの期間・条件の履歴が Gemini に送信されるか」を簡潔に表示する。

---

#### 3. トークン数とコストの「ざっくり感」の可視化

- 入力トークン数シミュレーション
  - 絞り込み条件に基づいて取得したプロンプト群＋`整理用プロンプト`から、Gemini に送信するリクエストの想定入力トークン数を計算・表示する。
- コスト・上限感の表示（ざっくり）
  - トークン数と合わせて、以下のようなラベルを表示する：
    - 「このモデルのコンテキスト上限の約◯％を使用します」
    - 「概算コスト：◯円／回（参考）」
  - 絞り込み条件（読み込み件数など）を変更した際に、リアルタイムでトークン数と概算コスト表示を更新する。
- 表示場所
  - 自動整理設定ダイアログの下部に、「今回の実行想定」セクションを設けて表示する。

---

#### 4. Pinnedリストのユーザー体験

- セクション分割
  - `menuType="pinned"` のリスト内で、以下のようにセクション分けして表示する：
    - セクションA：「あなたのピン留め」 … ユーザーが明示的にピンしたプロンプトのみ
    - セクションB：「AIのおすすめテンプレ」 … `AI自動作成`かつ「Pinned表示対象」のプロンプト
- 表示制御
  - `AI自動作成`プロンプトは、ユーザーが明示的に「ピンに昇格」した場合、
    「あなたのピン留め」セクションに移動できるようにする。
- アイコン・バッジ
  - `AI自動作成`プロンプトには、通常の星アイコンとは異なる軽い装飾（小さなAIラベルや色の違い）で区別する。
  - 初回未確認の `AI自動作成`プロンプトのみ、一度だけ「キラキラ」アニメーションを表示し、ユーザーが開くか実行した段階で通常表示に戻す。
    - AIっぽい、グラデーション＋キラキラした装飾
  - 初回未確認の `AI自動作成`プロンプトが存在した場合は、`menuType="pinned"`のリストのトリガーアイコン自体にも、同様の装飾を施す

---

#### 5. ユースケース／カテゴリの付与と提案

- ユースケース
  - ユーザーが「いつ使えるプロンプトか」を直感的に理解できるよう、テンプレごとにユースケースを1つ付与する。
  - ユースケースは、「状況＋目的」を一文で説明したもの(最大40文字)
  - 例：
    - 「取引先へ謝罪のメールを作る」
    - 「目標達成と顧客からフィードバックを伝える社内報告書を作成」
    - 「チームへすぐにTODOを共有できる議事録を作成」
    - 「ブログ記事のドラフトを作成」
- カテゴリ
  - ユースケースよりも抽象度の高い分類軸としてカテゴリを持たせる。
  - 例：
    - 対外コミュニケーション
    - 社内コミュニケーション
    - ドキュメント作成
    - 開発・技術
  - カテゴリは候補リスト＋ユーザー独自カテゴリの追加を許可する。
- 付与ロジック
  - Gemini に、対象プロンプト群と既存のカテゴリ一覧を渡し、
    - ユースケース候補（自然文）
    - カテゴリ候補（定義済みの選択肢＋必要に応じて新規候補）  
      を構造化出力で生成させる。
  - ユーザーはプレビュー画面で、ユースケース・カテゴリを編集・選択してから保存できる。
- 利用箇所
  - プロンプトリストの各行に、ユースケースをサブタイトルとして表示。
  - 補完メニューでは、ユースケース・カテゴリでフィルタ／並び替えができるようにする。

---

#### 6. 自動整理の設定ダイアログ

- 有効／無効
  - 「自動整理の有効・無効」をトグルで設定。
- 整理用プロンプト
  - デフォルトの「整理用プロンプト」をプリセットとして表示し、ユーザーが編集・上書き可能。
- 絞り込み条件（AND 条件）
  - 最終実行時期：1週／1ヶ月／1年
  - 最低実行回数：0〜任意の数値
  - 読み込み件数：10〜1000
- 実行時シミュレーション
  - 現在の条件での「想定入力トークン数」「コンテキスト使用率」「概算コスト」を表示（前述のとおり）。
- 起動方法は「マニュアル起動（ボタン押下で即時実行）」のみ

---

### 動作フロー

1. ユーザーが、自動整理設定ダイアログで条件を設定し、「整理する」ボタンを押す。
2. 絞り込み条件に従って、プロンプト履歴から対象プロンプトを抽出する。
3. `整理用プロンプト`と対象プロンプト群（JSON）を Gemini API に渡し、構造化出力で以下を得る：
   - テンプレ本文（変数化済み）
   - テンプレタイトル (20文字以内)
   - 抽出変数一覧
   - ユースケース候補
   - カテゴリ候補
   - 参照元プロンプトのID一覧 など
4. 生成結果をもとに `AI自動作成`プロンプトの候補を構築し、プレビュー用の一時データとして保持する。
5. 自動整理完了後、実行直後のサマリ（①）を表示する。

---

### 実行直後のサマリ（① 結果の全体像）

- 表示タイミング
  - 自動整理処理が完了したタイミングで、モーダルで表示。
- 表示内容（例）
  - タイトル：「プロンプトを自動整理しました」
  - 本文例：
    - 「新しいテンプレート 3件を作成しました」
    - 「対象：過去30日／50件のプロンプト」
  - アクションボタン：
    - 「プレビューを見る」
    - 「すべて保存する」

---

### プレビュー画面（② 1件ずつの確認）

- レイアウト
  - 左ペイン：生成された `AI自動作成`テンプレ一覧（タイトル＋ユースケース＋元件数など）。
  - 右ペイン：選択中テンプレの詳細プレビュー。
- 右ペイン詳細
  - テンプレ名（編集可）
  - ユースケース（テキスト入力で編集可）
  - カテゴリ（プルダウン＋カスタムカテゴリ追加可）
  - テンプレ本文（変数 `{...}` 部分はハイライト表示）
  - 抽出変数一覧（名前＋簡単な説明を表示）
  - 「元になったプロンプト例を表示」リンク（展開で2〜3件のサンプル本文）
- アクション
  - 「保存」：`AI自動作成`テンプレとしてストレージに保存。Pinned表示可否とセクションBへの配置。
  - 「保存してお気に入り」：保存しつつ、セクションA（あなたのピン留め）側にも昇格させるオプション。
  - 「保存しない」：当該候補を破棄。

---

### サマリの“ストーリー化”（③ 成功体験の演出）

- プレビュー画面上部または開始時の説明カードとして、以下のようなテキスト／カードを表示：
  - 例1：
    - 「よく使っている ‘取引先へのメール’ パターンを、変数付きテンプレートとして1件作成しました。」
    - 「今後、取引先へのメールはこのテンプレートから数クリックで呼び出せます。」
  - 例2：
    - 「一度しか使っていないが汎用化できそうなプロンプトを見つけ、『社内報告用』テンプレートにしました。」
- 代表的な1件を強調カードとして表示し、「このこのプロンプトを試してみる」ボタンを用意することで、その場で即利用できる成功体験をつくる。
- Pinned リストに遷移した後も、セクションBの上部に一時的なメッセージとして
  - 「新しく ‘社内報告用’ テンプレート 2件を追加しました」  
    を表示し、ユーザーが後からでも整理結果に気づけるようにする。
