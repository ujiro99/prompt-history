# Prompt Organizer 設計レビュー TODO リスト

## 📋 概要

**レビュー日**: 2025-11-20
**総合整合性スコア**: 74/100（良好だが注目すべきギャップあり）

### 進捗サマリー

- 🔴 優先度1（重大）: 5/5 完了 ✅
- 🟡 優先度2（重要）: 3/4 完了
- 🟢 優先度3（改善）: 4/11 完了
- **合計**: 13/20 完了（65%達成！）

---

## 🔴 優先度1: 重大な問題（実装前に必須修正）

### [x] TODO-01: GeminiClient API実装の統一 ✅

- **影響ドキュメント**: `05_api_design.md`
- **問題箇所**: 418-501行（SDK方式）vs 691-801行（Fetch方式）
- **修正内容**:
  - [x] Fetch APIベースの実装（691-801行）を完全に削除
  - [x] SDKベースのアプローチ（418-501行）のみを残す
  - [x] セクション6「GeminiClient 実装詳細」を整理し、SDK方式のみに統一
- **理由**: 既存の`GeminiClient.ts`は`@google/genai` SDKを使用しており、Fetch方式との混在は混乱を招く
- **関連TODO**: なし
- **完了日**: 2025-11-21

---

### [x] TODO-02: StoredPrompt型仕様の追加 ✅

- **影響ドキュメント**: `03_data_model.md`
- **問題箇所**: 54-84行（Prompt拡張の定義）
- **修正内容**:
  - [x] `StoredPrompt`拡張インターフェース定義を追加
    ```typescript
    export interface StoredPrompt
      extends Omit<Prompt, "createdAt" | "updatedAt"> {
      createdAt: string // ISO 8601
      updatedAt: string // ISO 8601
      isAIGenerated?: boolean
      aiMetadata?: AIGeneratedMetadata
      useCase?: string
      categoryId?: string
    }
    ```
  - [x] マイグレーションバージョン2の仕様を追加（既存プロンプトへの新フィールド追加）
  - [x] 各新規フィールドのデフォルト値を明記
- **理由**: 既存コードベースのストレージパターン（Prompt/StoredPromptの分離）との整合性確保
- **関連TODO**: TODO-05（ストレージ初期化パターン）
- **完了日**: 2025-11-21

---

### [ ] TODO-03: i18nキーマッピングの完成

- **影響ドキュメント**: `04_ui_flow.md`
- **問題箇所**: 498-568行（既存キー定義）、全体（未定義キー多数）
- **修正内容**:
  - [ ] 不足しているi18nキーをリストアップ:
    - サマリーダイアログメッセージ（110-133行）
    - エラーメッセージ（398-420行）
    - AI生成バッジラベル
    - 確認ボタンテキスト
    - コスト表示フォーマット
  - [ ] `src/locales/en.yml`、`ja.yml`の既存構造に合わせたキー設計
  - [ ] 完全なi18nキーマッピング表を追加
- **理由**: 実装時のi18nキー不足による手戻り防止
- **関連TODO**: なし

---

### [x] TODO-04: エラーハンドリングフローの詳細化 ✅

- **影響ドキュメント**: `02_architecture.md`、`05_api_design.md`
- **問題箇所**:
  - `02_architecture.md` 671-702行（エラーハンドリング概要）
  - `05_api_design.md` 502-559行（エラー型定義）
- **修正内容**:
  - [x] リトライロジックの詳細を追加:
    - リトライ回数: 最大3回
    - 待機時間: 指数バックオフ（1秒、2秒、4秒）
    - リトライ対象エラー: RATE_LIMIT, NETWORK_ERROR
  - [x] クォータエラー時のユーザーガイダンスを追加
  - [x] 部分的失敗の処理フロー（一部テンプレート成功時）を追加
  - [x] ネットワークタイムアウト仕様を追加（30秒に変更）
  - [x] 最小成功基準を定義（最低1テンプレート必要）
  - [x] エラー回復フローチャートを追加
- **理由**: 堅牢なエラーハンドリングによるユーザー体験向上
- **関連TODO**: TODO-03（エラーメッセージのi18n）
- **完了日**: 2025-11-21

---

### [x] TODO-05: ストレージ初期化パターンの修正 ✅

- **影響ドキュメント**: `02_architecture.md`、`03_data_model.md`
- **問題箇所**:
  - `03_data_model.md` 392-413行（ストレージ定義）
  - `02_architecture.md` 470-517行（initializeDefaults実装）
- **修正内容**:
  - [x] `categoriesStorage`定義に`fallback`を追加（DEFAULT_CATEGORIESを使用）
  - [x] `CategoryService.initializeDefaults()`の実装を削除
  - [x] デフォルトカテゴリ定義を別ファイル（`defaultCategories.ts`）に定数として定義
  - [x] `data-analysis`を`document-creation`に変更
- **理由**: 既存のWXT Storageパターン（`src/services/storage/definitions.ts`）との整合性
- **関連TODO**: TODO-02（StoredPrompt仕様）
- **完了日**: 2025-11-21

---

## 🟡 優先度2: アーキテクチャ上の問題（修正推奨）

### [x] TODO-06: PromptOrganizerServiceの責務分割 ✅

- **影響ドキュメント**: `02_architecture.md`
- **問題箇所**: 241-389行（PromptOrganizerService実装）
- **修正内容**:
  - [x] サービスを以下に分割:
    - `PromptFilterService`: フィルタリングロジック専用
    - `TemplateGeneratorService`: Gemini API呼び出しとオーケストレーション
    - `CostEstimatorService`: トークン数とコスト計算専用
    - `TemplateSaveService`: テンプレート永続化専用
  - [x] 各サービスの責務と公開メソッドを明記
  - [x] サービス間の依存関係図を追加
- **理由**: 単一責任の原則に従い、テスタビリティと保守性を向上
- **関連TODO**: TODO-08（AIプロバイダー抽象化）
- **完了日**: 2025-11-21

---

### [x] TODO-07: コンポーネント階層のフラット化 ✅

- **影響ドキュメント**: `02_architecture.md`、`04_ui_flow.md`
- **問題箇所**:
  - `02_architecture.md` 126-172行（コンポーネント階層）
  - `04_ui_flow.md` 57-94行（設定ダイアログUI）
- **修正内容**:
  - [x] 深いネスト構造を見直し:

    ```
    変更前:
    OrganizerSettingsDialog
      └─ FilterSettings
          └─ PeriodSelector
          └─ ExecutionCountInput
          └─ MaxPromptsInput
      └─ ExecutionEstimate
          └─ TokenCountDisplay
          └─ ContextUsageBar
          └─ CostEstimate

    変更後:
    OrganizerSettingsDialog
      └─ PeriodSelector（直接配置）
      └─ ExecutionCountInput（直接配置）
      └─ MaxPromptsInput（直接配置）
      └─ TokenCountDisplay（直接配置）
      └─ ContextUsageBar（直接配置）
      └─ CostEstimate（直接配置）
    ```

  - [x] プロップドリリング削減
  - [x] 既存の`InputPopup.tsx`パターンに合わせたフラット構造に変更

- **理由**: 既存UIコンポーネントパターンとの整合性、状態管理の簡素化
- **関連TODO**: なし
- **完了日**: 2025-11-21

---

### [ ] TODO-08: AIプロバイダー抽象化レイヤーの追加

- **影響ドキュメント**: `02_architecture.md`、`05_api_design.md`
- **問題箇所**: `05_api_design.md` 全体（Gemini固有実装）
- **修正内容**:
  - [ ] AIプロバイダーインターフェース定義を追加:

    ```typescript
    interface AITemplateGenerator {
      generateTemplates(request: OrganizeRequest): Promise<Template[]>
      estimateCost(request: OrganizeRequest): Promise<CostEstimate>
    }

    class GeminiTemplateGenerator implements AITemplateGenerator {
      // Gemini固有の実装
    }
    ```

  - [ ] アーキテクチャ図に抽象化レイヤーを追加
  - [ ] 将来的な他プロバイダー（Claude、GPT-4など）への拡張方法を記載

- **理由**: 将来的なAIプロバイダー切り替えの柔軟性確保
- **関連TODO**: TODO-06（サービス分割）

---

### [x] TODO-09: システムインストラクション処理の明確化 ✅

- **影響ドキュメント**: `03_data_model.md`、`05_api_design.md`
- **問題箇所**:
  - `03_data_model.md` 158-174行（SYSTEM_INSTRUCTION定義）
  - `05_api_design.md` 186-198行（プロンプト構築）
- **修正内容**:
  - [x] システムインストラクションは`GeminiClient`の`config.systemInstruction`で渡すことを明記
  - [x] プロンプトテキスト構築時にシステムインストラクションを含めないことを明記
  - [x] コード例を修正:
    ```typescript
    const response =
      await geminiClient.generateStructuredContent<OrganizePromptsResponse>(
        buildPromptText(request), // organizationPrompt + カテゴリ + プロンプトのみ
        responseSchema,
        {
          systemInstruction: SYSTEM_INSTRUCTION, // 別途configで渡す
        },
      )
    ```
- **理由**: システムインストラクションとユーザープロンプトの明確な分離
- **関連TODO**: なし
- **完了日**: 2025-11-21

---

## 🟢 優先度3: 完全性のギャップ（あると良い改善）

### [x] TODO-10: カテゴリ管理機能の追加 ✅

- **影響ドキュメント**: `02_architecture.md`、`04_ui_flow.md`
- **問題箇所**: `02_architecture.md` 433-521行（カテゴリサービス）
- **修正内容**:
  - [x] カテゴリ削除フローの追加（セクション4.3.1）
  - [x] カテゴリ削除時のプロンプト処理方針を定義:
    - オプション1: カテゴリIDをnullに設定 ✅ 採用
    - cleanupOrphanedPrompts()メソッドを実装
  - [x] カテゴリリネーム機能の追加（rename()メソッド）
  - [x] デフォルトカテゴリの削除防止ロジックを追加（canDelete()メソッド）
  - [x] カテゴリCRUD操作のUI仕様を追加（セクション4.3.2）
  - [x] i18nキーを定義（en/ja）
- **理由**: 完全なカテゴリ管理機能の提供
- **関連TODO**: なし
- **完了日**: 2025-11-21

---

### [x] TODO-11: テスト設計ドキュメントの作成 ✅

- **影響ドキュメント**: 新規ドキュメント `06_test_design.md`
- **問題箇所**: なし（欠落）
- **修正内容**:
  - [x] 新規ドキュメント作成: `06_test_design.md`
  - [x] 以下のセクションを含める:
    - セクション1: ユニットテストケース（7サービス、26テストケース）
    - セクション2: 統合テストシナリオ（3シナリオ）
    - セクション3: E2Eテストフロー（3フロー）
    - セクション4: モックデータ構造
    - セクション5: テストカバレッジ目標（80%以上）
    - セクション6: パフォーマンステスト仕様
    - セクション7: テスト実行コマンドとCI/CD統合
- **理由**: `CLAUDE.md`ガイドライン準拠、テスト駆動開発の促進
- **関連TODO**: なし
- **完了日**: 2025-11-21

---

### [x] TODO-12: 変数システム統合の明確化 ✅

- **影響ドキュメント**: `03_data_model.md`、`02_architecture.md`
- **問題箇所**: `03_data_model.md` 119-125行（ExtractedVariable定義）
- **修正内容**:
  - [x] `ExtractedVariable`（Gemini出力）から`VariableConfig`（ストレージ形式）への変換ロジックを追加
  - [x] 既存の変数展開機能との統合方法を記載
  - [x] 変数入力ダイアログの動作仕様を追加
  - [x] 変数デフォルト値の設定方法を追加
- **理由**: 既存の変数展開機能とのシームレスな統合
- **関連TODO**: なし
- **完了日**: 2025-11-21

---

### [ ] TODO-13: 重複排除アルゴリズムの定義

- **影響ドキュメント**: `02_architecture.md`、`05_api_design.md`
- **問題箇所**: `01_requirements.md` 15行（重複排除への言及）
- **修正内容**:
  - [ ] 重複検出アルゴリズムを定義:
    - 方式: レーベンシュタイン距離またはコサイン類似度
    - 閾値: 類似度0.85以上で重複とみなす
  - [ ] 重複検出時の処理方針を定義:
    - 類似テンプレートをマージ
    - sourceCountが多い方を優先
    - 変数が多い方を優先
  - [ ] 実装詳細を`05_api_design.md`に追加
- **理由**: 重複テンプレート削減によるユーザー体験向上
- **関連TODO**: なし

---

### [ ] TODO-14: アクセシビリティ仕様の追加

- **影響ドキュメント**: `04_ui_flow.md`
- **問題箇所**: 443-475行（キーボード操作への言及のみ）
- **修正内容**:
  - [ ] スクリーンリーダー用アナウンステキストを追加
  - [ ] ARIA属性仕様を追加（role、aria-label、aria-describedbyなど）
  - [ ] キーボードショートカット完全版テーブルを追加
  - [ ] フォーカス管理の詳細仕様を追加
  - [ ] 色のコントラスト比仕様を追加（WCAG 2.1 AAレベル準拠）
  - [ ] アクセシビリティチェックリストを追加
- **理由**: WCAG 2.1準拠、全ユーザーへのアクセシビリティ確保
- **関連TODO**: なし

---

### [x] TODO-15: showInPinnedロジックの定義 ✅

- **影響ドキュメント**: `03_data_model.md`、`02_architecture.md`
- **問題箇所**: `03_data_model.md` 113行（showInPinnedフィールド）
- **修正内容**:
  - [x] `showInPinned`を`true`に設定する基準を明確化:
    ```typescript
    // 以下の両方を満たす場合にshowInPinned = true (AND条件)
    criteria = {
      sourceCount >= 3,      // 元プロンプト3件以上
      variables.length >= 2, // 変数2つ以上（汎用性高い）
    }
    ```
  - [x] デフォルト値（`false`）を明記
  - [x] ユーザーによる手動ピン/アンピン機能の追加
- **理由**: AIレコメンデーション基準の透明性確保
- **関連TODO**: なし
- **完了日**: 2025-11-21

---

### [x] TODO-16: 確認状態遷移図の追加 ✅

- **影響ドキュメント**: `04_ui_flow.md`
- **問題箇所**: 335-362行（確認フローの記述）
- **修正内容**:
  - [x] 詳細な状態遷移図を追加（セクション6.1）:
    ```
    [生成完了] → [プレビュー] → [保存済み] → [未確認/確認済み/ピン留め]
                      ↓              ↓
                   [破棄]         [削除]
    ```
  - [x] 各状態でのユーザーアクション（クリック、ホバー、キーボード）を明記
    - プレビュー状態: マウス操作とキーボード操作を詳細に記載（セクション6.2.1）
    - 保存済み（未確認）状態: クリック/実行/ホバー/右クリック（セクション6.2.2）
    - 確認済み状態: 通常操作（セクション6.2.3）
    - ピン留め状態: セクションA表示（セクション6.2.4）
  - [x] 状態遷移トリガー条件を明記（各状態のセクションに記載）
  - [x] 各状態でのUI表示変化を明記（キラキラアニメーション、バッジ表示など）
  - [x] 状態遷移の実例を追加（セクション6.3）
- **理由**: UI実装時の曖昧さ排除
- **関連TODO**: なし
- **完了日**: 2025-11-21

---

### [ ] TODO-17: リクエストバッチング戦略の追加

- **影響ドキュメント**: `05_api_design.md`
- **問題箇所**: なし（欠落）
- **修正内容**:
  - [ ] 大量プロンプト処理時のチャンク化戦略を追加:
    - 最大プロンプト数/リクエスト: 100件
    - チャンク化ロジック: 100件ごとに分割
    - 進捗表示仕様: 「処理中 1/3」
  - [ ] トークン制限超過時の処理を追加
  - [ ] 各チャンクの結果マージロジックを追加
- **理由**: 大量データ処理時のAPI制限回避
- **関連TODO**: TODO-04（エラーハンドリング）

---

### [x] TODO-18: 入力検証仕様の追加 ✅

- **影響ドキュメント**: `03_data_model.md`、`05_api_design.md`
- **問題箇所**: 全体（検証ロジック未定義）
- **修正内容**:
  - [x] 検証ルールを追加:
    - テンプレート名: 最大20文字、超過時は切り詰め
    - ユースケース: 最大40文字、超過時は切り詰め
    - 変数名: 正規表現 `/^[a-zA-Z_][a-zA-Z0-9_]*$/`
    - カテゴリ名: 最大30文字、予約語チェック
  - [x] 検証エラー時のユーザーメッセージを追加（i18nキー定義）
  - [x] サニタイゼーションロジックを追加（HTMLエスケープ、変数構文保護）
  - [x] `03_data_model.md`セクション9.2に詳細な検証仕様を追加（7サブセクション）
  - [x] `05_api_design.md`セクション9.7に検証フローの統合を追加
- **理由**: データ整合性確保、セキュリティ向上
- **関連TODO**: TODO-19（プロンプトインジェクション対策）
- **完了日**: 2025-11-21

---

### [ ] TODO-19: プロンプトインジェクション対策の追加

- **影響ドキュメント**: `05_api_design.md`、`02_architecture.md`
- **問題箇所**: なし（欠落）
- **修正内容**:
  - [ ] 組織化プロンプトの入力サニタイゼーション仕様を追加
  - [ ] システムインストラクション保護策を追加
  - [ ] 危険な文字列パターンのブロックリストを定義
  - [ ] セキュリティ考慮事項セクションを追加
- **理由**: セキュリティリスク軽減
- **関連TODO**: TODO-18（入力検証）

---

### [ ] TODO-20: ストレージ増加管理戦略の追加

- **影響ドキュメント**: `02_architecture.md`、`03_data_model.md`
- **問題箇所**: なし（欠落）
- **修正内容**:
  - [ ] AI生成テンプレートの上限を定義:
    - 最大保存数: 100件
    - 超過時の処理: 古いテンプレート（最終実行日が古い）を自動削除
  - [ ] アーカイブ機能仕様を追加（オプション）
  - [ ] ストレージクリーンアップUI仕様を追加
  - [ ] ユーザーへの通知方法を定義
- **理由**: ストレージ無制限増加の防止、パフォーマンス維持
- **関連TODO**: なし

---

## 📈 推奨作業順序

以下の順序で段階的に修正することを推奨します：

### フェーズ1: 基盤修正（必須）✅ 完了

1. TODO-01: GeminiClient API実装の統一 ✅
2. TODO-02: StoredPrompt型仕様の追加 ✅
3. TODO-05: ストレージ初期化パターンの修正 ✅
4. TODO-09: システムインストラクション処理の明確化 ✅

### フェーズ2: データと仕様の完全化（必須）✅ 完了

5. TODO-04: エラーハンドリングフローの詳細化 ✅
6. TODO-12: 変数システム統合の明確化 ✅

### フェーズ3: アーキテクチャ改善（推奨）✅ 完了

7. TODO-06: PromptOrganizerServiceの責務分割 ✅
8. TODO-07: コンポーネント階層のフラット化 ✅

### フェーズ4: 機能補完とセキュリティ（推奨）✅ 完了

9. TODO-15: showInPinnedロジックの定義 ✅
10. TODO-18: 入力検証仕様の追加 ✅

### フェーズ5: UXとテスト（改善）✅ 完了

11. TODO-10: カテゴリ管理機能の追加 ✅
12. TODO-16: 確認状態遷移図の追加 ✅
13. TODO-11: テスト設計ドキュメントの作成 ✅

---

## 📝 メモ欄

修正作業中に気づいた点や、追加で必要になった作業をここに記録してください。

### 除外項目

今回の設計レビューでは以下のTODOは除外します：

- TODO-03 については設計というより実装寄りの内容が多いため、設計書では明記しない。
- TODO-08 については、将来的な設計を見据えた内容なので、今回の設計書では明記しない。
- TODO-13 については、具体的なアルゴリズム選定が必要なため、今回の設計書では明記しない。
- TODO-14 については、アクセシビリティの詳細設計は別途行うため、今回の設計書では明記しない。
- TODO-17 については、今回はスコープ外として、設計書には含めない。
- TODO-19 については、今回はスコープ外として、設計書には含めない。
- TODO-20 については、今回はスコープ外として、設計書には含めない。

---

**最終更新日**: 2025-11-20
