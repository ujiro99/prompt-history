# 変数エディター共通化設計

## 1. 概要

### 1.1 目的

EditDialogとOrganizerPreviewDialogで使用されている変数設定機能を共通コンポーネント化し、両方のダイアログで完全なCRUD操作（閲覧、編集、追加、削除）を可能にする。

### 1.2 背景

現在、以下の2つの実装が存在している：

- **EditDialog**: 変数の設定を編集可能な形式で表示（VariableConfigFieldを使用）
- **OrganizerPreviewDialog**: 変数を読み取り専用で表示

OrganizerPreviewDialogでも変数の編集が必要になったため、共通コンポーネントを作成して機能を統一する。

### 1.3 スコープ

**対象範囲**:

- 変数設定セクションの共通コンポーネント化
- 変数のCRUD操作のサポート
- 自動検出機能の統合
- 両ダイアログへの適用

**対象外**:

- 変数展開機能（既存機能として維持）
- 変数入力ダイアログ（実行時の入力UI）
- 変数パーサーの変更

## 2. 要件

### 2.1 機能要件

#### FR-1: 変数の閲覧

- 変数名、型、設定値を表示できること
- 読み取り専用モードをサポートすること

#### FR-2: 変数の編集

- 変数の型を変更できること
- デフォルト値を設定できること
- 選択肢（select型の場合）を設定できること

#### FR-3: 自動検出による変数の追加・削除

- プロンプトコンテンツから変数を自動検出できること
- コンテンツに新しい変数が追加されたら、自動的に変数リストに追加されること
- コンテンツから変数が削除されたら、自動的に変数リストから削除されること
- 既存の設定を保持しながら新しい変数を追加できること

**注**: 変数の追加・削除は手動では行わず、プロンプトコンテンツの編集を通じて自動的に行われる。

### 2.2 非機能要件

#### NFR-1: ユーザビリティ

- 直感的なUI/UXを提供すること
- 操作の流れを中断しない設計とすること
- 適切なフィードバックを提供すること

#### NFR-2: 再利用性

- 複数のコンテキストで使用可能なこと
- カスタマイズ可能な設定を提供すること
- 既存のコンポーネントと整合性を保つこと

#### NFR-3: 保守性

- コードの重複を排除すること
- 明確な責務分離を行うこと
- テスタブルな設計とすること

## 3. コンポーネントアーキテクチャ

### 3.1 コンポーネント構成

新しく作成する共有コンポーネントは以下の1つ：

#### VariableSettingsSection（変数設定セクション）

**配置場所**: `src/components/shared/VariableSettingsSection.tsx`

**責務**:

- 変数リスト全体の管理
- 自動検出ロジックの統合（オプション）
- 変数設定の表示と編集
- 子コンポーネントの配置とレイアウト

**主要な設定項目**:

- 表示モード（閲覧/編集）
- 自動検出の有効/無効
- UIのカスタマイズオプション

**使用する既存コンポーネント**:

- **VariableConfigField**: 個別の変数設定の表示と編集に使用
- **ScrollAreaWithGradient**: スクロール可能なリスト表示に使用

### 3.2 コンポーネント階層

```
VariableSettingsSection (統括)
│
├─ ヘッダーセクション
│  ├─ ラベル
│  └─ 説明テキスト
│
├─ ScrollAreaWithGradient (スクロール領域)
│  │
│  └─ VariableConfigField[] (変数リスト)
│     ├─ 変数名表示（読み取り専用）
│     ├─ 型セレクター（編集可能）
│     └─ 設定入力フィールド（編集可能）
│
└─ 空状態メッセージ（変数が0の場合）
```

### 3.3 既存コンポーネントとの関係

- **VariableConfigField**: そのまま使用（個別の変数設定）
- **ScrollAreaWithGradient**: そのまま使用（スクロールコンテナ）
- **variableParser utilities**: そのまま使用（自動検出、検証）

## 4. UI/UXフロー

### 4.1 変数の閲覧フロー

1. コンポーネントが`mode="view"`で初期化される
2. 変数リストが読み取り専用形式で表示される
3. 各変数には以下の情報が表示される：
   - 変数名（`{{variableName}}`形式）
   - 変数の型
   - 設定値（表示のみ）

### 4.2 変数の編集フロー

1. コンポーネントが`mode="edit"`で初期化される
2. 各変数のフィールドが編集可能になる
3. ユーザーが型を変更すると、対応する入力フィールドが切り替わる
4. 変更は即座に親コンポーネントに伝播される

### 4.3 自動検出による追加・削除フロー

**変数の追加**:

1. ユーザーがプロンプトコンテンツに`{{newVariable}}`を追加
2. コンテンツ変更が検出される
3. `mergeVariableConfigs()`が実行され、新しい変数が検出される
4. 既存の設定を保持しながら、新しい変数がリストに追加される
5. 新しい変数はデフォルトで`type="text"`で追加される
6. 変数リストが更新され、新しい変数が表示される

**変数の削除**:

1. ユーザーがプロンプトコンテンツから`{{oldVariable}}`を削除
2. コンテンツ変更が検出される
3. `mergeVariableConfigs()`が実行され、削除された変数が検出される
4. 該当の変数がリストから削除される
5. 変数リストが更新される

**シナリオ1: EditDialog（外部管理）**:

1. 親コンポーネントがコンテンツの変更を監視（useEffect）
2. コンテンツ変更時に`mergeVariableConfigs()`で変数を自動検出
3. 検出結果をVariableSettingsSectionに渡す
4. コンポーネントは受け取った変数を表示

**シナリオ2: OrganizerPreviewDialog（内部管理）**:

1. コンポーネントがコンテンツを受け取る
2. コンテンツ変更時に内部で`mergeVariableConfigs()`を実行
3. 既存の設定とマージ
4. 更新された変数リストを表示

## 5. データモデル

### 5.1 入力データ

#### 変数リスト

- 型: `VariableConfig[]`
- 各変数には以下の属性が含まれる：
  - name: 変数名
  - type: 変数の型（text, select, exclude）
  - defaultValue: デフォルト値（任意）
  - selectOptions: 選択肢（select型の場合）

#### コンテンツ

- 型: `string`（任意）
- 自動検出が有効な場合に使用
- `{{variableName}}`パターンを含む

### 5.2 内部状態

#### 変数リスト（内部管理の場合のみ）

- コンポーネント内部で管理される変数の配列（enableAutoDetection=trueの場合）
- 外部から受け取った変数を初期値とする
- コンテンツ変更時に自動的に更新される
- 変更は親コンポーネントに伝播される

### 5.3 出力データ

#### 変数リストの変更

- 型: `VariableConfig[]`
- CRUD操作によって変更された変数リスト
- onChange コールバックを通じて親に通知

## 6. 統合設計

### 6.1 EditDialogへの統合

**現状**:

- 243-268行目に変数設定セクションが実装されている
- 外部でuseEffectを使用して自動検出を実装
- VariableConfigFieldを直接使用

**変更内容**:

- 既存の変数セクションを削除
- VariableSettingsSectionに置き換え
- 自動検出は外部で継続（enableAutoDetection=false）
- 既存の動作を完全に維持

**影響範囲**:

- EditDialog.tsx のみ
- 既存の動作に変更なし
- テストは既存のものを使用

### 6.2 OrganizerPreviewDialogへの統合

**現状**:

- 212-233行目に読み取り専用の変数表示が実装されている
- シンプルなリスト表示のみ
- 編集機能なし

**変更内容**:

- 読み取り専用セクションを削除
- VariableSettingsSectionに置き換え（編集モード）
- 自動検出を内部で実装（enableAutoDetection=true）
- 変数の編集操作を追加

**新機能**:

- 変数の型、デフォルト値、選択肢の編集が可能になる
- コンテンツ変更時の自動追加・削除（自動同期）

**注**: 変数の手動追加・削除機能は提供しない。コンテンツの編集により自動的に管理される。

### 6.3 共有ディレクトリ構造

```
src/components/shared/
├── VariableSettingsSection.tsx
└── index.ts
```

**index.ts の役割**:

- VariableSettingsSectionをエクスポート
- 外部からの使用を簡素化

## 7. 国際化（i18n）

### 7.1 追加が必要なキー

新しい翻訳キーの追加は不要。既存のキーを使用する：

- `dialogs.edit.variableSettings` - セクションタイトル
- `dialogs.edit.variableSettingsDescription` - セクション説明

### 7.2 言語対応

既存の翻訳ファイルに変更なし。

## 8. テスト設計

### 8.1 単体テストの範囲

#### VariableSettingsSection

- 表示モード切り替え（view/edit）
- 自動検出の有効/無効
- 変数リストの表示
- 空状態の表示
- ヘッダーのカスタマイズ
- 高さ制限とスクロール
- 変数の編集操作
- onChange コールバックの発火

### 8.2 統合テストの範囲

#### EditDialogとの統合

- 既存の動作が維持されること
- 変数の編集が正常に機能すること
- 外部の自動検出が正常に機能すること

#### OrganizerPreviewDialogとの統合

- 変数の編集が可能になること
- 内部の自動検出が正常に機能すること
- コンテンツ変更時の自動追加・削除が機能すること

### 8.3 主要なテストケース

1. ビューモードでの読み取り専用表示
2. 編集モードでの編集可能フィールド表示
3. コンテンツ変更時の自動検出（内部管理）
4. コンテンツに変数追加時の自動追加
5. コンテンツから変数削除時の自動削除
6. 変数の型変更時のonChange発火
7. 変数のデフォルト値変更時のonChange発火
8. 空状態の正しい表示
9. ScrollAreaWithGradientの正しい表示

## 9. エッジケースの処理

### 9.1 変数展開が無効な場合

**状況**:
`settings.variableExpansionEnabled = false`の状態。

**処理**:

- EditDialogは変数セクションを表示しない
- 既存の動作を維持

**目的**:
設定に基づいた適切な動作を保証する。

### 9.2 変数設定の保持

**状況**:
ユーザーが変数`{{userName}}`の型を`select`に変更し、選択肢を設定した後、一時的にコンテンツから`{{userName}}`を削除する。

**処理**:

1. コンテンツから変数が削除される
2. `mergeVariableConfigs()`により変数リストから削除される
3. 設定情報（型、選択肢）は失われる
4. ユーザーが再度`{{userName}}`をコンテンツに追加した場合、デフォルトの`type="text"`で再作成される

**注意**:
変数の設定は保持されない。これは既存の`mergeVariableConfigs()`の動作に従う。

**目的**:
既存の動作との一貫性を保つ。

### 9.3 複数箇所での同時編集

**状況**:
OrganizerPreviewDialogで変数を編集している間に、コンテンツも同時に編集される。

**処理**:

1. コンテンツ変更が自動検出をトリガー
2. `mergeVariableConfigs()`が実行され、変数リストが更新される
3. 既存の変数設定は保持される
4. 新しい変数が追加される
5. 削除された変数が除去される

**目的**:
コンテンツと変数リストの一貫性を保つ。

## 10. 実装フェーズ

### フェーズ1: 基礎コンポーネントの作成

- 共有ディレクトリの作成（`src/components/shared/`）
- VariableSettingsSectionの実装
  - 基本構造の作成
  - 表示モード（view/edit）の実装
  - 自動検出ロジックの実装（オプション）
  - ScrollAreaWithGradientの統合
  - VariableConfigFieldの統合
- エクスポート設定（`index.ts`）
- 単体テストの作成

### フェーズ2: EditDialogへの統合

- インポートの更新
- 既存コードの削除（243-268行目）
- VariableSettingsSectionへの置き換え
- 動作確認（変数の編集が正常に機能すること）
- 既存テストの実行（regression確認）

### フェーズ3: OrganizerPreviewDialogへの統合

- インポートの更新
- 既存コードの削除（212-233行目）
- VariableSettingsSectionへの置き換え（編集モード）
- 新機能の動作確認
  - 変数の編集が機能すること
  - 自動検出が機能すること
- 統合テストの作成

### フェーズ4: 仕上げ

- JSDocコメントの追加
- アクセシビリティレビュー
- 最終テスト
- ドキュメントの更新

## 11. リスクと制約

### 11.1 リスク

#### R-1: 既存機能の破壊

- **影響**: EditDialogの既存動作が変わる可能性
- **軽減策**: 段階的な実装、既存テストの実行

#### R-2: パフォーマンス

- **影響**: 自動検出の頻繁な実行によるパフォーマンス低下
- **軽減策**: 適切なメモ化、useEffectの依存関係管理

#### R-3: 状態の同期

- **影響**: 親子コンポーネント間の状態不整合
- **軽減策**: 明確な状態管理パターン、単一の真実の源泉

### 11.2 制約

#### C-1: 既存のUIパターン

- 既存のVariableConfigFieldのUIパターンを維持する必要がある
- ScrollAreaWithGradientを使用する必要がある

#### C-2: 国際化

- すべてのテキストは英語と日本語で提供する必要がある

#### C-3: アクセシビリティ

- キーボード操作をサポートする必要がある
- スクリーンリーダーに対応する必要がある

## 12. 参考資料

### 12.1 関連ファイル

- `src/components/inputMenu/controller/EditDialog.tsx`
- `src/components/inputMenu/controller/VariableConfigField.tsx`
- `src/components/promptOrganizer/OrganizerPreviewDialog.tsx`
- `src/utils/variables/variableParser.ts`
- `src/components/inputMenu/ScrollAreaWithGradient.tsx`

### 12.2 関連型定義

- `VariableConfig` (src/types/prompt.ts)
- `VariableType` (src/types/prompt.ts)
- `SelectOptions` (src/types/prompt.ts)

### 12.3 関連ユーティリティ

- `mergeVariableConfigs()` - 変数のマージと自動検出
- `parseVariables()` - コンテンツからの変数抽出
- `isValidVariableName()` - 変数名の検証
- `expandPrompt()` - 変数の展開
