# プロンプトのインポート・エクスポート機能 設計書

## 1. 概要

保存済みプロンプトをCSVファイルとしてエクスポート・インポートする機能を提供する。
設定メニューからアクセス可能で、プロンプトのバックアップや共有、移行を容易にする。

## 2. 要件

### 2.1 機能要件

#### 2.1.1 エクスポート機能

- 保存済みプロンプトをCSVファイルとしてエクスポート
- すべてのプロンプトデータ（名前、内容、変数設定、ピン状態など）を含む
- ファイル名は`prompt-autocraft-YYYYMMDD-HHMMSS.csv`形式
- ワンクリックでダウンロード開始

#### 2.1.2 インポート機能

- CSVファイルからプロンプトをインポート
- ファイル選択ダイアログからCSVを選択
- 重複チェック機能（同名・同内容のプロンプトを検出）
- インポート結果の通知（成功数、重複数）

### 2.2 非機能要件

#### 2.2.1 データ形式

- CSV形式（UTF-8エンコーディング）
- ヘッダー行を含む
- 変数設定はJSON文字列として格納
- エスケープ処理の適切な実装

#### 2.2.2 エラーハンドリング

- 不正なCSVファイルの検証
- フォーマットエラーの明確なエラーメッセージ
- 部分的なインポート失敗時の適切な処理

## 3. データ構造

### 3.1 CSV形式

```csv
name,content,executionCount,lastExecutedAt,isPinned,lastExecutionUrl,createdAt,updatedAt,variables
"プロンプト名","プロンプト内容",5,"2024-01-01T00:00:00.000Z",true,"https://example.com","2024-01-01T00:00:00.000Z","2024-01-01T00:00:00.000Z","[{\"name\":\"var1\",\"type\":\"text\"}]"
```

**注意**: CSVには`id`フィールドは含まれません。インポート時に新しいIDが自動生成されます。

### 3.2 型定義

```typescript
interface PromptCSVRow {
  name: string
  content: string
  executionCount: number
  lastExecutedAt: string
  isPinned: boolean
  lastExecutionUrl: string
  createdAt: string
  updatedAt: string
  variables?: string // JSON文字列
}
```

## 4. アーキテクチャ

### 4.1 実装ファイル

#### 4.1.1 promptExportService.ts

- プロンプトデータの収集
- CSV形式への変換
- ファイルのダウンロード処理

**主要メソッド**:

- `exportToCSV()`: プロンプトをCSVとしてエクスポート

#### 4.1.2 promptImportService.ts

- CSVファイルの読み込み
- データのパース・バリデーション
- 重複チェック
- プロンプトの保存処理

**主要メソッド**:

- `importFromCSV(file: File)`: CSVファイルからプロンプトをインポート

#### 4.1.3 types.ts

インポート・エクスポートに関連する型定義：

- `PromptCSVRow`: CSV行の型定義
- `ImportResult`: インポート結果の型定義

### 4.2 設定メニューとの統合

- SettingsMenuコンポーネントから呼び出し
- MenubarItemのonClickイベントで実行
- ImportDialogコンポーネントでインポートUIを提供

## 5. データフロー

### 5.1 エクスポートフロー

```
ユーザーがエクスポートボタンクリック
↓
promptExportService.exportToCSV()
↓
プロンプトデータ取得（PromptServiceFacade経由）
↓
CSV形式に変換
↓
Blobオブジェクト作成
↓
ダウンロードリンク生成・クリック
↓
CSVファイルダウンロード
```

### 5.2 インポートフロー

```
ユーザーがインポートボタンクリック
↓
ImportDialog表示
↓
ファイル選択
↓
promptImportService.importFromCSV(file)
↓
CSVパース
↓
データバリデーション
↓
重複チェック
↓
プロンプトデータ保存（PromptServiceFacade経由）
↓
インポート結果通知
↓
ダイアログクローズ
```

## 6. テストケース

### 6.1 エクスポート機能テスト

1. **正常系**
   - エクスポートボタンクリック
   - CSVファイルがダウンロードされること
   - ファイル名が正しい形式であること
   - CSVの内容がすべてのプロンプトを含むこと
   - 変数設定が正しくJSON文字列化されていること

2. **エッジケース**
   - プロンプトが0件の場合
   - 特殊文字を含むプロンプトの場合
   - 大量のプロンプトの場合

### 6.2 インポート機能テスト

1. **正常系**
   - インポートボタンクリック
   - ファイル選択ダイアログ表示
   - 正常なCSVファイルのインポート成功
   - インポート結果通知の表示
   - インポートされたプロンプトの確認

2. **重複チェック**
   - 既存プロンプトと同一のデータをインポート
   - 重複数が正しくカウントされること
   - 重複プロンプトがスキップされること

3. **異常系**
   - 不正なCSV形式
   - 必須フィールドの欠損
   - 不正なJSON文字列（variables）
   - エンコーディングエラー
   - 適切なエラーメッセージの表示

## 7. 考慮事項

### 7.1 セキュリティ

- CSVインジェクション対策
- XSS対策（インポートデータのサニタイゼーション）
- ファイルサイズ制限

### 7.2 パフォーマンス

- 大量プロンプトのエクスポート/インポート最適化
- バッチ処理の実装
- プログレス表示（将来的な拡張）

### 7.3 互換性

- 既存のエクスポート形式との互換性維持
- 将来的なフィールド追加への拡張性確保
- バージョン管理の検討

### 7.4 ユーザビリティ

- インポート前のプレビュー機能（将来的な拡張）
- 選択的インポート機能（将来的な拡張）
- エクスポート範囲の選択（全て/ピンのみ等、将来的な拡張）
