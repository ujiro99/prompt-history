# セッション管理機能 設計書

## 1. 概要

プロンプト履歴管理において、ユーザーがプロンプトを実行した後の状態を追跡し、実行中のプロンプトに対する操作（上書き保存など）を適切に管理するためのセッション管理機能。

## 2. 機能要件

### 2.1 目的

- **実行コンテキストの追跡**: どのプロンプトが実行されたかを記録し、実行中の状態を管理する
- **上書き保存の実現**: 実行中のプロンプトに対して、修正内容を上書き保存できるようにする
- **適切なセッション終了**: URL変更やページ離脱時に、セッション状態を適切にクリーンアップする
- **セッション復元**: ページリロード後に、セッション状態を復元し、URL変更があれば終了する

### 2.2 セッションの定義

セッションとは、「プロンプトを実行してから次のアクションが行われるまでの期間」を指す。

**セッションに含まれる情報**:

- 実行中のプロンプトID
- セッション開始URL
- セッション開始時刻

## 3. セッション状態遷移図

```
      [初期状態: セッションなし]
                  |
                  | プロンプト実行
                  ↓
         [アクティブセッション]
                  |
      ┌───────────┼───────────┐
      |           |           |
  URL変更    プロンプト   明示的終了
      |         削除          |
      ↓           ↓           ↓
      [    セッションなし     ]
```

## 4. データ構造

### 4.1 Session型

```typescript
interface Session {
  activePromptId: string | null // 実行中プロンプトID
  url: string // セッション開始URL
  startedAt: Date // セッション開始時刻
}
```

### 4.2 ストレージ

- **ストレージキー**: `session`
- **ストレージタイプ**: WXT Storage API（session storage相当）
- **永続性**: タブクローズ時に削除される

## 5. アーキテクチャ

### 5.1 コンポーネント構成

```
┌───────────────────────────┐
│  PromptServiceFacade      │  ← 統合層
├───────────────────────────┤
│  SessionManager           │  ← セッション管理層
├───────────────────────────┤
│  StorageService           │  ← ストレージ層
└───────────────────────────┘
```

### 5.2 SessionManager

**責務**:

- セッションの開始・終了
- セッション状態の取得
- ページイベントへの対応

**主要な公開メソッド**:

- `startSession(promptId)`: セッション開始
- `endSession()`: セッション終了
- `restoreSession()`: セッション復元
- `getCurrentSession()`: 現在のセッション取得
- `hasActiveSession()`: アクティブセッション判定
- `handlePageUnload()`: ページアンロードハンドラ
- `handlePageChange()`: ページ変更ハンドラ

## 6. セッションライフサイクル

### 6.1 セッション開始トリガー

#### プロンプト実行時（自動）

```
プロンプト選択
  ↓
プロンプト実行
  ↓
セッション開始（promptIdを記録）
  ↓
実行カウントインクリメント
```

#### 明示的な開始（手動）

- UI層から `PromptServiceFacade.startSession()` を呼び出し

### 6.2 セッション終了トリガー

#### 1. 明示的な終了（手動）

- UI層から `PromptServiceFacade.endSession()` を呼び出し

#### 2. プロンプト削除時（自動）

```
プロンプト削除要求
  ↓
削除対象がアクティブプロンプト？
  ↓ Yes
セッション終了
```

#### 3. URL変更時（自動）

```
ページ履歴変更（popstate）またはアプリ初期化
  ↓
セッション復元処理
  ↓
セッションURL ≠ 現在URL？
  ↓ Yes
セッション終了
```

#### 4. ページアンロード時（自動）

```
beforeunload イベント
  ↓
セッション終了
```

### 6.3 ライフサイクル図

```
[初期化]
  └─ restoreSession()
     └─ URLが変更されていたら → endSession()

[プロンプト実行]
  └─ executePrompt(promptId)
     └─ startSession(promptId)

[セッション終了]
  ├─ 明示的な終了: endSession()
  ├─ プロンプト削除: deletePrompt() → endSession()
  ├─ URL変更: restoreSession() → endSession()
  └─ ページ離脱: beforeunload → endSession()
```

## 7. セッション状態の活用

### 7.1 上書き保存判定

**用途**: 手動保存ダイアログで上書き保存オプションの表示/非表示を制御

```
保存ダイアログ表示
  ↓
セッション存在？
  ├─ Yes → 上書き保存オプション表示
  └─ No  → 新規保存のみ
```

### 7.2 実行回数のインクリメント

**用途**: 自動保存時に、実行されたプロンプトの実行カウントを更新

```
自動保存実行
  ↓
セッション存在？
  ├─ Yes → 元のプロンプトの実行回数もインクリメント
  └─ No  → 新規プロンプトの実行回数のみカウント
```

## 8. イベント管理

### 8.1 監視イベント

| イベント       | 目的                                  | ハンドラ             |
| -------------- | ------------------------------------- | -------------------- |
| `beforeunload` | ページ離脱時のクリーンアップ          | `handlePageUnload()` |
| `popstate`     | ブラウザバック/フォワード時の状態管理 | `handlePageChange()` |

### 8.2 イベントライフサイクル

```
アプリケーション初期化
  ↓
イベントリスナー登録
  ↓
[アプリケーション動作中]
  ↓
アプリケーション破棄
  ↓
イベントリスナー解除
```

## 9. セッション管理フロー

### 9.1 プロンプト実行からセッション開始

```
User → InputPopup → ExecuteManager → SessionManager → Storage
 |         |              |                 |              |
 |      プロンプト      実行処理        セッション       状態保存
 |       クリック                         開始
```

### 9.2 上書き保存フロー

```
User → SaveDialog → StorageHelper → SessionManager → Storage
 |         |              |                 |              |
 |      上書き         セッション       プロンプトID    上書き保存
 |      保存選択        確認             取得
```

### 9.3 URL変更時のセッション終了

```
Browser → PromptServiceFacade → SessionManager → Storage
   |              |                    |             |
popstate      handlePageChange    restoreSession   状態確認
   |              |                    |             |
   |              |                URL比較           |
   |              |                    |             |
   |              |               endSession     状態削除
```

## 10. テスト設計

### 10.1 ユニットテスト

**対象**: SessionManager

- セッション開始・終了の基本動作
- セッション状態の取得
- URL変更時の自動終了
- イベントハンドラの動作

### 10.2 統合テスト

**対象**: セッション管理と他コンポーネントの連携

- プロンプト実行 → セッション開始 → 上書き保存
- プロンプト削除 → セッション終了
- URL変更 → セッション終了
- ページリロード → セッション復元

### 10.3 E2Eテスト

**対象**: ブラウザ環境でのエンドツーエンドフロー

- プロンプト実行後の上書き保存フロー
- ブラウザナビゲーション時のセッション終了
- ページリロード後のセッション状態

## 11. 将来の拡張性

### 11.1 複数セッション対応

- タブごとのセッション管理
- 会話スレッドごとのセッション管理
- セッション履歴の保存

### 11.2 セッション統計

- プロンプトごとのセッション継続時間
- セッション終了理由の分析
- セッション中の編集回数

### 11.3 セッション同期

- クラウドストレージへのセッション保存
- デバイス間でのセッション復元
- セッション競合の解決

## 12. 注意事項

### 12.1 データの一貫性

- セッション開始/終了は常に対になるように設計
- 例外発生時もセッション状態を適切にクリーンアップ
