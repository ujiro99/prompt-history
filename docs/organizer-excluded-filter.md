# プロンプトリストフィルタ機能設計

## 概要

プロンプト一覧画面において、Organizerから除外されたプロンプト（`excludeFromOrganizer === true`）かつユーザーが作成したプロンプト（`isAIGenerated === false`）を表示対象から除外するフィルタ機能を追加する。

## 機能要件

### FR-1: フィルタ条件

- ユーザーが「Organizerから除外されたプロンプトを非表示」機能を有効化できる
- 有効時、以下の条件を満たすプロンプトを一覧から除外する：
  - `excludeFromOrganizer`プロパティが`true`
  - かつ`isAIGenerated`プロパティが`false`（またはundefined）
- 無効時は全てのプロンプトを表示（従来通り）

### FR-2: 設定の永続化

- フィルタのON/OFF状態をlocalStorageに保存する
- ページ再読み込み後も設定が維持される
- 設定はアプリケーション設定（AppSettings）の一部として管理する

### FR-3: UI要件

- 既存のソート順序選択（SortOrderSelect）を拡張し、フィルタ設定も含む総合的な設定ポップアップに変更する
- 設定ポップアップには以下を含む：
  - ソート順序選択（既存機能）
  - フィルタオプション（新機能）
    - 「Organizerから除外されたプロンプトを非表示」チェックボックス
- ポップアップは歯車アイコン（Settings2）をトリガーとして表示する

## UIフロー

### 設定変更フロー

1. ユーザーがプロンプト一覧の検索バー右側にある歯車アイコンをクリック
2. 設定ポップアップが表示される
3. ポップアップ内で以下の操作が可能：
   - ソート順序の変更（既存）
   - 「Organizerから除外されたプロンプトを非表示」チェックボックスのON/OFF
4. チェックボックスを変更すると即座にフィルタが適用される
5. 設定が自動的にlocalStorageに保存される

### フィルタ適用フロー

1. プロンプトデータが読み込まれる
2. 検索クエリによるフィルタリングが適用される（既存）
3. 「Organizerから除外されたプロンプトを非表示」設定が有効な場合：
   - 検索結果から条件に合致するプロンプトを除外
4. ソート順序に従ってグループ化される（既存）
5. フィルタ・グループ化されたプロンプトが表示される

## 機能アーキテクチャ

### データフロー

1. **設定管理層**
   - AppSettings型に新しいフィルタ設定プロパティを追加
   - useSettingsフックを通じて設定の読み取り・更新を行う
   - WXT Storage APIを使用してlocalStorageに永続化

2. **フィルタリング層**
   - PromptListコンポーネントのuseMemo内でフィルタロジックを実装
   - 処理順序：
     1. 検索クエリによるフィルタリング
     2. Organizerから除外されたプロンプトのフィルタリング（新規）
     3. ユーザーピン留めとAI生成テンプレートの分離
     4. グループ化とソート

3. **UI層**
   - SortOrderSelectコンポーネントを設定ポップアップに拡張
   - Popoverコンポーネントを使用して設定UIを表示
   - CheckboxコンポーネントでフィルタのON/OFFを制御

### コンポーネント構成

- **PromptList**（親コンポーネント）
  - フィルタロジックを含むuseMemoを管理
  - 設定ポップアップコンポーネントを配置

- **PromptSettingsPopup**（新規コンポーネント、または拡張されたSortOrderSelect）
  - ソート順序選択UI
  - フィルタオプションUI
  - useSettingsフックを使用して設定を取得・更新

## 外部仕様

### 設定項目

**プロパティ名**: `hideOrganizerExcluded`

**型**: `boolean`

**デフォルト値**: `false`

**説明**: trueの場合、`excludeFromOrganizer === true`かつ`isAIGenerated === false`のプロンプトを一覧から除外する

### フィルタ適用条件

以下の全てを満たすプロンプトが非表示対象となる：

1. `hideOrganizerExcluded`設定が`true`
2. プロンプトの`excludeFromOrganizer`プロパティが`true`
3. プロンプトの`isAIGenerated`プロパティが`false`または`undefined`

注意：AI生成プロンプト（`isAIGenerated === true`）は、`excludeFromOrganizer`の値に関わらず常に表示される

### UI要素

**設定トリガー**

- アイコン: Settings2（歯車）
- 位置: 検索バー右端
- 動作: クリックで設定ポップアップを開く

**設定ポップアップ**

- 表示方式: Popover（ドロップダウン形式）
- 内容:
  - セクション1: ソート順序
    - ラジオボタンまたはセレクトボックス
    - オプション: 最近使用順、実行回数順、名前順、総合スコア順
  - セクション2: フィルタオプション
    - チェックボックス: 「Organizerから除外されたプロンプトを非表示」

## 主要な型定義

### AppSettings型の拡張

既存の`AppSettings`インターフェースに以下のプロパティを追加：

```
hideOrganizerExcluded?: boolean
```

- オプショナルプロパティ（既存データとの互換性のため）
- デフォルト値: false

### 関連する既存の型

**Prompt型**（既存）

- `excludeFromOrganizer?: boolean` - Organizerから除外するフラグ
- `isAIGenerated?: boolean` - AI生成フラグ

## テスト設計

### 単体テスト

**テストケース1: フィルタロジックの検証**

- テスト対象: フィルタリング処理
- 入力条件の組み合わせ:
  - `hideOrganizerExcluded: false` → 全てのプロンプトを表示
  - `hideOrganizerExcluded: true, excludeFromOrganizer: false` → プロンプトを表示
  - `hideOrganizerExcluded: true, excludeFromOrganizer: true, isAIGenerated: false` → プロンプトを非表示
  - `hideOrganizerExcluded: true, excludeFromOrganizer: true, isAIGenerated: true` → プロンプトを表示（AI生成は除外対象外）
  - `hideOrganizerExcluded: true, excludeFromOrganizer: true, isAIGenerated: undefined` → プロンプトを非表示

**テストケース2: 設定の永続化**

- 設定変更後、localStorageに正しく保存されることを確認
- ページ再読み込み後、保存された設定が復元されることを確認

**テストケース3: 検索との組み合わせ**

- 検索クエリとフィルタが同時に適用された場合の動作を確認
- 検索でヒットしたプロンプトのうち、フィルタ条件に該当するものが除外されることを確認

### 結合テスト

**テストケース4: UIインタラクション**

- 設定ポップアップの開閉動作
- チェックボックスのON/OFF操作
- 設定変更による即座のプロンプトリスト更新

**テストケース5: ソート順序との組み合わせ**

- 各ソート順序（最近使用順、実行回数順、名前順、総合スコア順）でフィルタが正しく動作することを確認
- グループ化された状態でフィルタが適用されることを確認

### E2Eテスト

**テストケース6: エンドツーエンドシナリオ**

1. 拡張機能を読み込む
2. Organizerから除外されたプロンプトを含む複数のプロンプトを作成
3. フィルタをONにして、該当プロンプトが非表示になることを確認
4. フィルタをOFFにして、全てのプロンプトが表示されることを確認
5. ページをリロードして、設定が保持されていることを確認

## 実装上の考慮事項

### パフォーマンス

- フィルタリング処理はuseMemo内で実行され、依存配列が変更された場合のみ再計算される
- 検索クエリはuseDeferredValueでデバウンスされており、フィルタ処理も同様に最適化される

### 後方互換性

- 新しい設定プロパティはオプショナルとして定義し、既存のデータとの互換性を保つ
- 設定が未定義の場合はfalse（無効）として扱う

### ユーザビリティ

- フィルタの状態を視覚的に分かりやすく表示する
- フィルタによって非表示になっているプロンプトがある場合、ユーザーに通知することを検討（将来の拡張）

### 国際化（i18n）

- チェックボックスのラベルテキストを翻訳キーで管理
- 英語と日本語の両方で適切な表現を用意
- 推奨キー: `settings.hideOrganizerExcluded`

## 将来の拡張性

### 追加フィルタオプション

今後、以下のようなフィルタオプションを追加することが想定される：

- カテゴリによるフィルタ
- 実行回数によるフィルタ
- AI生成プロンプトの表示/非表示

### 高度な検索

フィルタと検索を統合した高度な検索インターフェース
