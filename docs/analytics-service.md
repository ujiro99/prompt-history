# Analytics Service 設計書

## 概要

現在、複数のコンポーネントに分散しているアナリティクストラッキング機能を一元化するための設計を示す。

## 現状分析

### 使用箇所

現在、analyticsは以下のファイルでインポート・使用されている：

1. `src/entrypoints/content.tsx` - 自動トラッキングの初期化
2. `src/components/inputMenu/controller/EditDialog.tsx` - "edit-save"イベント
3. `src/components/inputMenu/controller/PromptImproveDialog.tsx` - "improve_prompt"と"input_prompt"イベント
4. `src/services/promptHistory/executeManager.ts` - "insert-prompt"と"set-prompt"イベント

### 現在のパターン

**自動トラッキングの初期化:**

- 場所: content.tsx:43
- 使用方法: `analytics.autoTrack(container)`
- コンテンツスクリプトのマウント時に1回呼び出される

**イベントトラッキング:**
すべてのイベントトラッキングは同じパターンに従う：

```
try {
  await analytics.track("event-name")
} catch (error) {
  console.warn("Analytics tracking failed:", error)
}
```

**トラッキング対象イベント:**

- `edit-save` - EditDialogでユーザーが編集を保存したとき
- `improve_prompt` - ユーザーがAIでプロンプトを改善したとき
- `input_prompt` - ユーザーが改善されたプロンプトを入力したとき
- `insert-prompt` - ユーザーがカーソル位置にプロンプトを挿入したとき
- `set-prompt` - ユーザーがプロンプトテキスト全体を設定したとき

### 現在の実装の問題点

1. **コードの重複**: try-catchのエラーハンドリングがすべての場所で繰り返されている
2. **型安全性の欠如**: イベント名が型チェックなしのプレーン文字列である
3. **定義の分散**: イベント名が使用時点で定義されている
4. **テストの困難さ**: `#imports`への直接依存によりモック化が困難
5. **保守の負担**: 新しいイベントを追加する際にエラーハンドリングパターンを覚える必要がある

## 提案する解決策

### アーキテクチャ

以下の機能を持つAnalytics Serviceを作成する：

1. WXT analyticsモジュールをラップする
2. 型安全なイベントトラッキングを提供する
3. エラーを一貫して処理する
4. すべてのイベントを一箇所で定義する
5. 依存性注入によって容易なテストを可能にする

### サービス構造

**ディレクトリ構造:**

```
src/services/analytics/
├── index.ts              # メインのサービスエクスポート
├── AnalyticsService.ts   # サービス実装
├── events.ts             # イベント名定数と型
└── __tests__/
    └── AnalyticsService.test.ts
```

### イベント定義戦略

型抽出を用いてイベントをconstオブジェクトとして定義する：

- イベント名を定数として集約
- 型安全なイベントトラッキング
- 新しいイベントの追加が容易
- 自己文書化されたイベントカタログ

### エラーハンドリング戦略

サービス内でエラーハンドリングを集約する：

- すべてのエラーを内部でキャッチしてログ出力
- 呼び出し側コードにエラーをスローしない
- 一貫した警告メッセージ
- カスタムハンドリング用のオプショナルなエラーコールバック

### パブリックAPI

**初期化:**

- 自動トラッキングを初期化するメソッド
- コンテンツスクリプトから1回呼び出される

**イベントトラッキング:**

- 型安全なtrackメソッド
- 事前定義されたイベント名のみを受け付ける
- voidを返す（fire-and-forget方式）
- エラーをスローしない

**設定:**

- 必要に応じて基礎となるanalyticsインスタンスへのアクセス
- テスト用にトラッキングを無効化する機能

### 移行戦略

**Phase 1: サービス作成**

1. AnalyticsServiceを実装
2. イベント定数を定義
3. ユニットテストを追加

**Phase 2: 使用箇所の移行**

1. content.tsxの初期化部分を更新
2. EditDialog.tsxを更新
3. PromptImproveDialog.tsxを更新
4. executeManager.tsを更新

**Phase 3: クリーンアップ**

1. 直接のanalyticsインポートを削除
2. すべてのトラッキングが動作することを確認
3. ドキュメントを更新

### メリット

1. **保守性**: アナリティクスイベントの単一の信頼できる情報源
2. **型安全性**: イベント名のコンパイル時チェック
3. **一貫性**: 統一されたエラーハンドリング
4. **テスト容易性**: モック化とテストが簡単
5. **ドキュメント性**: すべてのイベントが一箇所で可視化
6. **スケーラビリティ**: 新しいイベントとトラッキング機能の追加が簡単

## 主要な型定義

**AnalyticsEvent**

- すべての有効なイベント名のユニオン型
- イベント定数オブジェクトから派生
- コンパイル時の型安全性を保証

**AnalyticsService インターフェース**

- `track(event: AnalyticsEvent): Promise<void>` - イベントをトラッキング
- `autoTrack(container: HTMLElement): void` - 自動トラッキングを初期化
- `isEnabled(): Promise<boolean>` - アナリティクスが有効かチェック

**イベントメタデータ**

- イベント名
- 説明
- 使用箇所への参照

## テスト戦略

**ユニットテスト:**

- モック化されたanalyticsでイベントトラッキングをテスト
- エラーハンドリングがスローしないことをテスト
- 自動トラッキング初期化をテスト
- 有効/無効状態の処理をテスト

**統合テスト:**

- 実際のコンポーネントでイベントがトラッキングされることを確認
- アナリティクス設定が尊重されることをテスト

## 非機能要件

**パフォーマンス:**

- 直接のanalytics呼び出しと比べて顕著なオーバーヘッドがないこと
- イベントトラッキングがUI操作をブロックしないこと

**信頼性:**

- アナリティクスの失敗がコア機能に影響を与えないこと
- アナリティクスが無効な場合の適切な劣化

**互換性:**

- 既存のWXT analytics設定とシームレスに動作すること
- Google Analytics 4プロバイダーとの互換性を維持すること
